# Mysql索引

## SQL优化简介

#### 1.什么情况下进行SQL优化

​	性能低，执行时间太长。等待时间太长、连接查询、索引失效

#### 2.SQL语句执行过程

 1. 编写过程

    ```mysql
    select distinct ... from ... join ... on ... where ... group by ... having ... order by ... limit ...
    ```

2. 解析过程

   ```mysql
   from ... on ... join ... where ... group by ... having ... select distinct ... order by ... limit ...
   ```

#### 3.SQL优化就是优化索引

​	索引相当于书的目录，其数据结构为B+树

## 索引

#### 1.索引是什么

​	索引是一种能提高数据库查询效率的数据结构。他可以比作一本字典的目录，可以帮你快速找到对应的记录。

​	索引一般存储在磁盘的文件中，他是占用物理空间的

​	适当的索引能提高查询效率，过多的索引会影响数据库表的插入和更新功能

#### 2.索引的分类

##### 2.1按字段分类

1. 主键索引（primary key）：一种特殊的唯一索引，不允许有空值
2. 普通索引（index）：mysql中基本索引类型，允许空值和重复值
3. 全文索引（fulltext）：为了检索大文本数据中的关键字的信息
4. 唯一索引（unique）：索引列中的值必须唯一的，但是允许为空值

##### 2.2按索引字段个数分类

1. 单列索引：建立在单个列上的索引

2. 联合索引：多个字段创建的索引，使用时遵循最左前缀原则、

   > 最左前缀原则：
   >
   > 例如组合索引（a，b，c），组合索引的生效原则是
   >
   > 从前往后依次使用生效，如果中间某个索引没有使用，那么断点前面的索引部分起作用，断点后面的索引没有起作用
   >
   > where a=3 and b=45 and c=5 .... 这种三个索引顺序使用中间没有断点，全部发挥作用；
   >
   > where a=3 and c=5... 这种情况下b就是断点，a发挥了效果，c没有效果
   >
   > where b=3 and c=4... 这种情况下a就是断点，在a后面的索引都没有发挥作用，这种写法联合索引没有发挥任何效果；
   >
   > where b=45 and a=3 and c=5 .... 这个跟第一个一样，全部发挥作用，abc只要用上了就行，跟写的顺序无关

#### 3.索引什么时候失效

- 查询条件包含or，可能导致索引失效
- 如果字段类型是字符串，where时一定用引号括起来，否则索引失效
- like通配符可能导致索引失效
- 联合索引，查询时的条件列不是联合索引中的第一个列，索引失效
  - 在索引列上使用mysql的内置函数，对索引列运算（+ - * /）,索引字段上使用（!=或者<>,not in）,is null,is not null，索引失效
- 左连接查询或者右连接查询查询关联的字段编码格式不一样，可能导致索引失效

#### 4.MySQL索引原理 - > B+树

- B+树非叶子节点上是不存储数据的，仅存储键值，而B树节点中不仅存储键值，也会存储数据。innodb中页的默认大小为16KB，如果不存储数据，那么就会存储更多的键值，相应的树的阶数就会更大，树就会更矮更胖，如此一来我们查找数据进行磁盘的io次数再次减少，数据查询的效率也会更快
- B+树索引的所有数据均存储在叶子结点，而且数据是按照顺序排列的，链表连着的。那么B+树使得范围查找，排序查找，分组查找以及去重查找变得异常简单

#### 5.大表如何添加索引

​	如果一张表数据量级是千万级别以上的，那么，如何给这张表添加索引？

​	我们需要知道一点，给表添加索引的时候，是会对表加锁的。如果不谨慎操作，有可能出现生产事故。可以参考一下方法：

 	1. 先创建一张跟原表A数据结构相同的新表B
 	2. 在新表B添加需要加上的新索引
 	3. 把原表A数据导到新表B
 	4. rename新表B为原表的表名A，原表A换别的表名

> 锁是计算机协调多个进程或者线程并发访问某一资源的机制
>
> 加锁的目的：锁保证数据并发访问的一致性、有效性；锁冲突是影响数据库并发访问性能的一个重要因素；锁是mysql在服务器层和存储引擎层的并发控制。所以加锁是为了解决客户端并发访问的冲突问题
>
> 锁的分类：
>
> 1. 按照锁的粒度划分:行锁、表锁、页锁
> 2. 按照锁的使用方式划分：共享锁、排它锁
> 3. 按照思想上的方式划分：悲观锁、乐观锁

#### 6.如何知道语句是否走索引查询

​	explain查看SQL的执行计划，这样就知道是否命中索引了

​	explain与SQL一起使用时，mysql将显示来自优化器的有关语句执行计划的信息，一般来说，需要重点关注type、rows、filtered、extra、key

#### 7.SQL语句优化

1. **select语句务必指明字段名称**
2. **只查询一条数据时，使用limit**
3. **避免在where子句中对字段进行null值判断**
4. **避免在where子句中对字段进行表达式操作**
5. **应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描**
6. **对于联合索引来说，要遵守最左前缀法则**
7. **join时，小表在左，大表在右**
8. **注意范围查询语句**

​	对于联合索引来说，如果存在范围查找，比如between、>、<等条件时，会造成后面的索引字段失效。

​	解决办法：业务允许的情况下，使用>=或者<=，这样不影响索引的使用

9. **不建议使用%前缀模糊查询**
10. **在where子句中使用or来连接条件，如果or连接的条件有一方没有索引，将导致引擎放弃使用索引而进行全表扫描**

​	解决办法：将or连接的双方都建立索引，就可以使用

11. **指定查询的索引**
12. **insert优化**

​	需要插入多条数据的时候，使用批量插入

​	多次插入数据时，采用手动提交事务

13. **order by 排序优化（排序时，使用索引的字段进行排序）**
14. **updata优化（避免出现表锁），使用索引**
15. **创建表时使用同一种编码**
